# UI自动化测试

更快的测试速度，带来更高的测试效率。一般而言，运行一遍功能测试都要以小时为单位，有的甚至以天为单位。而自动化测试则一般都在分钟级别，如果运行在分布式环境下，甚至可以降到秒级。由此可见，通过自动化测试，测试人员可以省去大量的手工测试时间，从而有更多时间去熟悉业务和完善测试用例，在提高自身测试效率的同时，也有助于提升整体的软件质量。

提高测试覆盖率。要理解这一点，首先要从[正交测试法](https://link.juejin.cn?target=http%3A%2F%2Fwww.jianshu.com%2Fp%2Fab31fef12f2f)说起。假设一个测试场景涉及3个测试因素，每个测试因素有3种可能的取值（水平），那么根据正交测试法，总共需要设计8个（`因素数*(最大水平数-1)+1`）测试用例。测试场景越复杂，所需的测试用例越多。当测试场景的复杂度超过一定程度后，纯手工的功能测试显然就无力覆盖所有的测试用例了，并且随着复杂度的升高，测试覆盖率会越来越低。然而，借助自动化测试脚本，无论测试场景多复杂，都能保证一定的测试覆盖率。

更好的稳定性和可扩展性。功能测试靠人，自动化测试靠机器，因此，无论是运行测试的稳定性，还是测试能力的可扩展性（比如从测试1个应用变为测试10个应用），自动化测试都远超功能测试。

回归测试。每一次应用发布，都伴随着一次回归测试。对于重复性的工作，机器显然更适合。

兼容性测试。不管是Web测试，还是App测试，兼容性测试都是必不可少的一环。以Web测试为例，同样的测试用例，需要在不同的浏览器上分别运行一遍，这对测试人员而言不可谓不是一种折磨。

大规模测试。如果一次测试涉及的测试用例过多（比如100+），功能测试难免会有遗漏或者重复，而自动化测试可以轻松确保一个不少，一个也不多。



## **Three.js的E2E方案**

提起社区基于Canvas的大型Web项目，很容易可以想出 Three.js ，是基于 Canvas 来执行WebGL的3D渲染。

翻了一下 Three.js 在Github上的官方仓库 [https://github.com/mrdoob/three.js](https://link.zhihu.com/?target=https%3A//github.com/mrdoob/three.js) ，找到e2e的测试源码的目录 ./test/e2e 发现 Three.js 的E2E 的测试步骤主要有两步

### **1. 确定正确期待值: 创建期望正确渲染的截图快照。**

- 启动一个静态文件的HTTP服务，加载 Three.js 本地的示例。
- 用无头浏览器(Headless browser) 访问示例，并保存3D正确效果的截图快照。
- 关闭HTTP服务。

![img](https://pic1.zhimg.com/50/v2-6b969b1d8f1db46c0965b0db1576810a_720w.jpg?source=1940ef5c)

### **2. 比对迭代前后差异:**

- 启动一个静态文件的HTTP服务，加载 Three.js 本地的示例。
- 用无头浏览器(Headless browser) 访问迭代后的示例，并将原有正确效果的图片做图片像素的差异匹配。如果匹配结果像素差异度大于 0.5% 就是测试用例失败。
- 关闭静态HTTP服务。

![img](https://pic1.zhimg.com/50/v2-7bc758ccc6125a973e22a776f0ae59df_720w.jpg?source=1940ef5c)

**3. 改进E2E测试，让差异可视化**

- 用 jimp 把匹配差异的像素标记给保存成图片，方便查看差异

![img](https://pic1.zhimg.com/50/v2-2cfb61c427fefd3764b40b3b3c4adc01_720w.jpg?source=1940ef5c)

- 第一张图片为预期正确结果。
- 第二张图片加了蓝色的圆环，为错误结果。
- 第三张图片是对比了预期和错误结果后，用红色像素标记出差异点。

修改后的链路流程图大致如下  

![img](https://pic3.zhimg.com/80/v2-e8f33138c88c3c0928640158f6b887cf_720w.jpg?source=1940ef5c)



**完整的E2E测试链路**

![img](https://pic1.zhimg.com/50/v2-f6a305b16578d0270109cb938e123e56_720w.jpg?source=1940ef5c)

## E2E测试

E2E（end to end）测试是一个边界比较模糊的概念，大概有这样几个特征吧：

- 把整个系统当作一个黑盒
- 测试人员模拟真实用户在浏览器中操作UI
- 测试出的问题可能是前端也可能是后端导致的

## 前端E2E

一般来说，我的Unit test是和业务代码同步编写的，调试和开发炒鸡方便。

主要的业务流程可能会写E2E，不过规模要小很多，主要目的是：

- 便于给PM展示业务流程
- 便于修改Bug之后的回归

## 为什么要进行UI自动化测试

业务的更新迭代频繁，传统测试大部分都还是手工、肉眼的模式来进行，无法满足产品敏捷开发、快速迭代的需求。而UI自动化能让全功能的回归变得简单，释放纯手工测试的人力资源，并且回归测试能够覆盖到所有的逻辑场景，这对测试的效率，以及整个开发流程的效率都是很大的提升，并且能够规避很多人的主观和客观因素导致的漏测或者疏忽。

其他测试方式的局限性：

**单元测试（Unit Testing）**

事实上，单元测试确实能够帮助我们发现大部分的问题，但是在复杂的前端交互中，单纯的单元测试并不能真实地反映用户操作的路径，而单元测试一般的场景是测试一系列的功能集合。

**快照测试（Snapshot Testing）**

DOM结构并不能完全反映页面的视觉效果，DOM结构不变并不完全等于样式不变。此外，大多数工具都是React专用，非React应用基本不支持。

*笔者想说：*

> 很多人认为，UI总是频繁的变动，导致测试用例维护成本高，性价比低，因此UI自动化测试比较适合场景稳定的业务。其实不是，这里的UI不仅仅指的是视觉，更多的是业务逻辑。UI可以多变，但业务逻辑一定是趋于稳定的，尤其是核心业务，想一想用户得多辛苦才能适应这种业务逻辑频繁变更的产品啊。

## 哪些项目适合引入自动化测试？

现实中，我们经常会针对一些活动开发一些一次性的代码模块，这样的代码模块功能简单，且后续继续迭代的可能性低，这种代码就完全没有必要引入自动化测试工具。

**适合引入自动化测试的场景：**

1. 公共库类的开发维护
2. 中长期项目的迭代/重构
3. 引用了不可控的第三方依赖

这些场景是需要引入自动化测试来对现有代码进行约束的。**尤其是中长期项目，迭代/重构时人力回归困难，自动化测试就显得尤为重要！**

## 什么样的项目适合自动化测试

性价比：按照测试金字塔模型以及投入/产出比，越向下，回报率越高；

Google的自动化分层投入占比：

- 小测试（Unit）：占比70%；
- 中测试（Service）：占比20%；
- 大测试（UI）：占比10%；

自动化测试面临的挑战：面临的最大挑战就是变化，因为变化会导致测试用例运行失败，所以需要对自动化脚本不断debug，如何控制成本、降低成本是对自动化测试工具以及人员能力的挑战。



![img](https://pic1.zhimg.com/80/v2-684651e3457ecce81212ba1a4f953530_720w.jpg)

### 功能自动化测试的条件：

- 需求相对稳定
- 冒烟测试通过
- 测试周期长

## 采用何种测试思想？

### TDD：Test-Driven Development（测试驱动开发）

- TDD：Test-Driven Development（测试驱动开发）：TDD 则要求在编写某个功能的代码之前先编写测试代码，然后只编写使测试通过的功能代码，通过测试来推动整个开发的进行

### BDD：Behavior-Driven Development（行为驱动开发）

- BDD：Behavior-Driven Development（行为驱动开发）：BDD 可以让项目成员（甚至是不懂编程的）使用自然语言来描述系统功能和业务逻辑，从而根据这些描述步骤进行系统自动化的测试

## selenium

Selenium是一个用于Web应用程序测试的工具。Selenium测试直接运行在浏览器中，就像真正的用户在操作一样。支持的浏览器包括IE(7、8、9)、Mozilla Firefox、Mozilla Suite等。这个工具的主要功能包括：测试与浏览器的兼容性——测试你的应用程序看是否能够很好得工作在不同浏览器和操作系统之上。测试系统功能——创建回归测试检验软件功能和用户需求。支持自动录制动作和自动生成 .Net、Java、Perl等不同语言的测试脚本。Selenium 是ThoughtWorks专门为Web应用程序编写的一个验收测试工具。其升级版本为Webdriver。

- Selenium IDE: 一款Firefox插件，以图形化方式支持录制脚本、自动生成脚本等功能。用于本地开发和调试TC（Test Case）。
- Selenium WebDriver: 通过各浏览器厂商提供的原生Driver，指挥浏览器进行各类页面操作。
- Selenium Grid: 适用于分布式环境下运行大量的TC，Hub根据TC的环境要求分发给各个符合条件的Node执行。使用Selenium Grid可以轻松搭建一个分布式的自动化测试环境，特别适合运行大规模的测试用例和兼容性测试（各个节点运行不同的WebDriver）![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2017/5/15/7a6f2962d7b9a634d492316d5a8a74ab~tplv-t2oaga2asx-watermark.awebp)
- 
